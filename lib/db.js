// Generated by CoffeeScript 1.7.1
(function() {
  var Grid, MongoClient, ObjectID, config, db_conn, debug, info, make_oid, str_id, warn, x, _ref, _ref1;

  x = typeof exports !== "undefined" && exports !== null ? exports : this;

  config = require('./config');

  _ref = require('./logger'), debug = _ref.debug, info = _ref.info, warn = _ref.warn;

  _ref1 = require('mongodb'), MongoClient = _ref1.MongoClient, ObjectID = _ref1.ObjectID, Grid = _ref1.Grid;

  db_conn = null;

  MongoClient.connect(config.db.url, function(err, db) {
    if (err) {
      warn("db.err:", err);
      process.exit(1);
    }
    info("db connected", db.databaseName);
    return db_conn = db;
  });

  x.OID = x.ObjectID = ObjectID;

  x.db_conn = function() {
    return db_conn;
  };

  x.coll = function(collection_name) {
    return db_conn.collection(collection_name);
  };

  x.make_oid = make_oid = function(id) {
    var err;
    try {
      return ObjectID(id);
    } catch (_error) {
      err = _error;
      return null;
    }
  };

  x.str_id = str_id = function(id) {
    var err;
    if (!id) {
      return null;
    }
    if (id instanceof ObjectID) {
      return id;
    }
    try {
      return ObjectID(id);
    } catch (_error) {
      err = _error;
      return "" + id;
    }
  };

  x.coll_dat = function() {
    return db_conn.collection("dat");
  };

  x.coll_st = function() {
    return db_conn.collection("st");
  };

}).call(this);
